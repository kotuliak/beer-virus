<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/template.css') }}">
    <script>

        if (!window.location.href.toString().endsWith("?room_id={{ room_id }}&user_name={{your_user.name}}")) {
             window.location.href = window.location.href + "?room_id={{ room_id }}&user_name={{your_user.name}}"
        }
    
        
    
    
        function usersShow() {
          var data = this.responseText;
          console.log(data)
          document.getElementById("users").innerHTML = data;
          var scripts = document.getElementById("users").getElementsByTagName('script');
            for (var ix = 0; ix < scripts.length; ix++) {
                console.log(scripts[ix].text)
                eval(scripts[ix].text);
            }
        }

        function yourUserShow() {
          var data = this.responseText;
          console.log(data)
          document.getElementById("user_text").innerHTML = data;
        }
    
        function locationClick(ev) {
            ev.preventDefault();
            console.log(ev.srcElement.innerText)
            var request = new XMLHttpRequest();
            request.addEventListener('load', locationShow);
            request.open('POST', {{ url_for('add_location')|tojson }});
            request.send(JSON.stringify({name:"{{your_user.name}}", location:ev.srcElement.innerText,roomid:"{{room_id}}"}));
        }
    
        function locationShow() {
          var data = this.responseText;
          console.log(data)
          document.getElementById("user_text").innerHTML = data;
    
        }
    
        function quarantineClick(ev) {
            ev.preventDefault();
            console.log(ev.srcElement.id.slice(3))
            var request = new XMLHttpRequest();
            request.addEventListener('load', quarantineShow);
            request.open('POST', {{ url_for('add_quarantine')|tojson }});
            request.send(JSON.stringify({name:"{{your_user.name}}",roomid:"{{room_id}}",quarantine: ev.srcElement.id.slice(3)}));
        }
    
        function quarantineShow() {
            var data = this.responseText;
            console.log(data)
            document.getElementById("users").innerHTML = data;
            var scripts = document.getElementById("users").getElementsByTagName('script');
            for (var ix = 0; ix < scripts.length; ix++) {
                console.log(scripts[ix].text)
                eval(scripts[ix].text);
            }
        }

        function resetGame(ev){
            ev.preventDefault();
            var request = new XMLHttpRequest();
            request.open('POST', {{ url_for('reset_game')|tojson }});
            request.send(JSON.stringify({roomid:"{{room_id}}"}));
        }

        function nextGame(ev){
            ev.preventDefault();
            var request = new XMLHttpRequest();
            request.open('POST', {{ url_for('next_game')|tojson }});
            request.send(JSON.stringify({roomid:"{{room_id}}"}));
        }
    </script>
</head>
<body>
    <div>
        <a href="{{ url_for('home') }}">Home</a>
    </div>

    <h1>Welcome {{ user_name }} to room {{Â room_id }}</h1>

    <div id="user_text">
        {% include 'user.html' %}
    </div>

    <ul id="users">
        {% include 'list_users.html' %}
    </ul>

    {% include 'choose_location.html' %}

    <p>
    </p>
    <br>
     
    {% if your_user.admin %}
        {% include 'admin.html' %}
    {% endif %}

    <script>
        for (i = 0; i < {{locations | length}}; i++) {
            console.log('l' + i.toString())
            var butloc = document.getElementById('l' + i.toString());
            console.log(butloc)
            it = i.valueOf()
            butloc.addEventListener('click', locationClick);
        }

        window.setInterval(function() {
            var request = new XMLHttpRequest();
            request.addEventListener('load', usersShow);
            request.open('POST', {{ url_for('show_users')|tojson }});
            request.send(JSON.stringify({name:"{{your_user.name}}", roomid:"{{room_id}}"}));

            var request = new XMLHttpRequest();
            request.addEventListener('load', yourUserShow);
            request.open('POST', {{ url_for('show_your_user')|tojson }});
            request.send(JSON.stringify({name:"{{your_user.name}}", roomid:"{{room_id}}"}));
        }, 1000);

        var reset = document.getElementById('reset')
        reset.addEventListener('click', resetGame);
        var next = document.getElementById('next')
        next.addEventListener('click', nextGame);
    </script>
</body>

